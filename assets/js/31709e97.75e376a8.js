"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[413],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return c}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),p=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),m=p(n),c=a,h=m["".concat(s,".").concat(c)]||m[c]||d[c]||i;return n?r.createElement(h,o(o({ref:t},u),{},{components:n})):r.createElement(h,o({ref:t},u))}));function c(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var p=2;p<i;p++)o[p]=n[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},3235:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return p},toc:function(){return u},default:function(){return m}});var r=n(7462),a=n(3366),i=(n(7294),n(3905)),o=["components"],l={id:"sleep",title:"Sleep and Power",sidebar_label:"Sleep and Power"},s=void 0,p={unversionedId:"testing_hardware/sleep",id:"testing_hardware/sleep",title:"Sleep and Power",description:"Current consumption on a BLE keyboard is dependent on how efficient the scanning routine is, how eficient it processes keystrokes, if/how the processor is put on hold, and BLE radio usage.",source:"@site/docs/testing_hardware/sleep.md",sourceDirName:"testing_hardware",slug:"/testing_hardware/sleep",permalink:"/docs/testing_hardware/sleep",editUrl:"https://github.com/jpconstantineau/pykey/tree/main/documentation/docs/testing_hardware/sleep.md",tags:[],version:"current",frontMatter:{id:"sleep",title:"Sleep and Power",sidebar_label:"Sleep and Power"},sidebar:"someSidebar",previous:{title:"Compared",permalink:"/docs/encoderpad/compared"}},u=[{value:"Normal Power Consumption",id:"normal-power-consumption",children:[],level:2},{value:"Deep Sleep vs Sleeping Beauty (System OFF)",id:"deep-sleep-vs-sleeping-beauty-system-off",children:[],level:2}],d={toc:u};function m(e){var t=e.components,n=(0,a.Z)(e,o);return(0,i.kt)("wrapper",(0,r.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"Current consumption on a BLE keyboard is dependent on how efficient the scanning routine is, how eficient it processes keystrokes, if/how the processor is put on hold, and BLE radio usage."),(0,i.kt)("p",null,"Current consumption of the BLE radio is much higher than that of the processor. However, as BLE messages are only occurring at a specific frequency and are not continuous, their impact on a time-averaged basis is not as significant than the running average of the processor running constantly. "),(0,i.kt)("p",null,"Reference:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://learn.adafruit.com/deep-sleep-with-circuitpython/alarms-and-sleep"},"Adafruit Learning Guide - CircuitPython Deep Sleep")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://circuitpython.readthedocs.io/en/latest/shared-bindings/alarm/index.html"},"CircuiPython ReadTheDocs")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://www.youtube.com/watch?v=RGR1rowOaX4&t=795s"},"Zephyr vs Arduino Power Consumption on the nRF52840 - Youtube Video")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/adafruit/Adafruit_nRF52_Arduino/issues/600"},"Gihub Issue: Bluefruit.begin() causes high power consumption")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/jpconstantineau/BlueMicro_BLE/blob/master/firmware/sleep.cpp"},"Sleep in Arduino - code example")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://infocenter.nordicsemi.com/pdf/nRF52840_PS_v1.1.pdf"},"nRF52840 datasheet (pdf)"))),(0,i.kt)("h2",{id:"normal-power-consumption"},"Normal Power Consumption"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Case"),(0,i.kt)("th",{parentName:"tr",align:null},"ZMK"),(0,i.kt)("th",{parentName:"tr",align:null},"BlueMicro_BLE"),(0,i.kt)("th",{parentName:"tr",align:null},"Code Below"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Framework"),(0,i.kt)("td",{parentName:"tr",align:null},"Zephyr"),(0,i.kt)("td",{parentName:"tr",align:null},"Adafruit_nRF52_Arduino"),(0,i.kt)("td",{parentName:"tr",align:null},"CircuitPython")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"connected to BLE"),(0,i.kt)("td",{parentName:"tr",align:null},"700-750 uA"),(0,i.kt)("td",{parentName:"tr",align:null},"950-1000 uA"),(0,i.kt)("td",{parentName:"tr",align:null},"6.8-7.2 mA")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Sleeping"),(0,i.kt)("td",{parentName:"tr",align:null},"50 uA"),(0,i.kt)("td",{parentName:"tr",align:null},"60 uA"),(0,i.kt)("td",{parentName:"tr",align:null},"160-200uA")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"measured using"),(0,i.kt)("td",{parentName:"tr",align:null},"PPK"),(0,i.kt)("td",{parentName:"tr",align:null},"PPK"),(0,i.kt)("td",{parentName:"tr",align:null},"PPK2")))),(0,i.kt)("p",null,"I tested the code below to see if time.sleep and alarm.light_sleep differed in power consumption and if one was better than the other.\nUnfortunately, both had the same power consumption with an average of 7mA.\nSuch a high current is similar to the issue filed on the Adafruit nRF52 arduino package when the cryptocell was implemented and power consumption jumped up significantly."),(0,i.kt)("p",null,"Note that this was done on August 27th and some changes were done in the CircuitPython ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/adafruit/circuitpython/pull/5273"},"Light Sleep")," code since then."),(0,i.kt)("h2",{id:"deep-sleep-vs-sleeping-beauty-system-off"},"Deep Sleep vs Sleeping Beauty (System OFF)"),(0,i.kt)("p",null,"The CircuitPython implementation of deep sleep isn't the same as what was implemented for the BlueMicro_BLE firmware.  The arduino implementation is quite simple:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"setup the anode (+ve) side of the keyboard matrix to be outputs and put them ",(0,i.kt)("inlineCode",{parentName:"li"},"HIGH"),". This will apply the necessary voltage to enable a trigger on the cathode side (-ve) when a key is pressed while sleeping "),(0,i.kt)("li",{parentName:"ul"},"setup GPIOs on the cathode side of the matrix to be ",(0,i.kt)("inlineCode",{parentName:"li"},"INPUT_PULLDOWN_SENSE")," "),(0,i.kt)("li",{parentName:"ul"},"call ",(0,i.kt)("inlineCode",{parentName:"li"},"sd_power_system_off();")," This is the softdevice call to completely power down the chip.")),(0,i.kt)("p",null,"At that point the chip powers down but when a key is pressed, it wakes up as if rebooting from a reset or a power up.  The ",(0,i.kt)("inlineCode",{parentName:"p"},"RESETREAS")," register would have the E bit set (see datasheet, page 75) on powerup. The bootloader does not appear to clear-out the ",(0,i.kt)("inlineCode",{parentName:"p"},"RESETREAS")," Regiter but does clear the ",(0,i.kt)("inlineCode",{parentName:"p"},"GPREGRET")," register if appropriate. ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/adafruit/Adafruit_nRF52_Bootloader/blob/master/src/main.c#L182"},"See code here")),(0,i.kt)("p",null,"When referring to the nRF52840 Datasheet, page 149 and 150, we see that this wake-up mechanism is simple (POWER Peripheral uses the DETECT signal to exit from System OFF mode) "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},'#pylint: disable = line-too-long\nimport time\nimport alarm\nimport board\nimport keypad\nimport pwmio\nimport adafruit_ble\nfrom adafruit_ble.advertising import Advertisement\nfrom adafruit_ble.advertising.standard import ProvideServicesAdvertisement\nfrom adafruit_ble.services.standard.hid import HIDService\nfrom adafruit_ble.services.standard.device_info import DeviceInfoService\nfrom adafruit_hid.keyboard import Keyboard\nfrom adafruit_hid.keyboard_layout_us import KeyboardLayoutUS\nfrom adafruit_hid.keycode import Keycode as KC\n\n# define audio hardware\nbuzzer = pwmio.PWMOut(board.P1_13, variable_frequency=True)\nOFF = 0\nON = 2**15\nnot_sleeping = True\n\n# define key GPIOs\nkeys = keypad.Keys(pins=(board.P0_29,board.P0_02,board.P0_28,board.P0_03,board.P0_10,board.P0_09,board.P0_24,board.P0_13),value_when_pressed=False)\n\n\nhid = HIDService()\n\ndevice_info = DeviceInfoService(software_revision=adafruit_ble.__version__,\n                                manufacturer="Adafruit Industries")\nadvertisement = ProvideServicesAdvertisement(hid)\nadvertisement.appearance = 961\nscan_response = Advertisement()\nscan_response.complete_name = "CircuitPython HID"\n\nble = adafruit_ble.BLERadio()\nif not ble.connected:\n    print("advertising")\n    ble.start_advertising(advertisement, scan_response)\nelse:\n    print("already connected")\n    print(ble.connections)\n\nkeyboard = Keyboard(hid.devices)\nkl = KeyboardLayoutUS(keyboard)\nlayer = 0\nkeymap = ((KC.A,KC.B,KC.C,KC.D,KC.E,KC.F,KC.G,KC.H),\n        (KC.A,KC.B,KC.C,KC.D,KC.E,KC.F,KC.G,KC.H))\n\n# End of Setup Music\nbuzzer.duty_cycle = ON\nbuzzer.frequency = 440\ntime.sleep(0.05)\nbuzzer.frequency = 880\ntime.sleep(0.05)\nbuzzer.frequency = 440\ntime.sleep(0.05)\nbuzzer.duty_cycle = OFF\n\nwhile True:\n    while not ble.connected:\n        pass\n    print("Start typing:")\n    while ble.connected:\n        key_event = keys.events.get()\n        if key_event:\n            key = keymap[layer][key_event.key_number]\n            if key_event.pressed:\n                keyboard.press(key)\n            else:\n                keyboard.release(key)\n        # time.sleep(0.02) # 6-7mA\n        # nothing 6-7mA\n        time_alarm = alarm.time.TimeAlarm(monotonic_time=time.monotonic() + 0.02) # 6-7mA too...\n        # Do a light sleep until the alarm wakes us.\n        alarm.light_sleep_until_alarms(time_alarm)\n        # Finished sleeping. Continue from here.\n    keys.deinit() # must release the pins in order to setup wake up alarm.\n    pin_alarm = alarm.pin.PinAlarm(pin=board.P0_29, value=False, pull=True)\n    alarm.exit_and_deep_sleep_until_alarms(pin_alarm)  # 160-200uA\n    ble.start_advertising(advertisement)\n')))}m.isMDXComponent=!0}}]);